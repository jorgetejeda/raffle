<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>

    <link rel="stylesheet" href="styles/colors.css">
    <link rel="stylesheet" href="styles/util.css">
    <link rel="stylesheet" href="styles/raffle.css">

</head>

<body onload="onLoad()">

    <img class="pearls" src="images/pearls@2x.png" alt="logo_header">
    <main>
        <div class="container">
            <div class="mask">
                <img src="images/mask@2x.png" alt="logo_raffle">
                <img src="images/mardi-text@2x.png" alt="raffle_text">
            </div>
            <button class="init-raffle btn-raffle" onclick="openModal()">Iniciar Rifa</button>

            <!-- Show counter -->
            <div class="counter"></div>

            <div class="game">
                <h1 class="names" attr="winner-id"></h1>
                <div class="winner hidden">
                    <h3 class="the-winner"></h3>
                    <div>
                        <h1 class="name"></h1>
                        <h3 class="department"></h3>

                    </div>
                    <h1 class="congratulations">Â¡Felicidades!</h1>

                    <div class="btn-raffle-actions">
                        <button class="restart-raffle btn-raffle" onclick="restartInitRaffle()">Rifar de nuevo</button>
                        <button class="generate-new-raffle btn-raffle" onclick="genereNewRaffle()">Generar Nuevo
                            Ganador
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>
    <footer></footer>

    <dialog>
        <div class="modal">
            <div class="modal-header">
                <h1 class="modal-title">Escoge el premio para la rifa</h1>
            </div>
            <div class="modal-body"></div>
            <div class="modal-footer">
                <div class="message-error"></div>
                <button class="cancel" onclick="closeModal()">Cancelar</button>
                <button class="confirm" onclick="priceChoosed()">Confirmar</button>
            </div>
        </div>
    </dialog>

    <script src="scripts/common.js"></script>
    <script>

        let participants = [];
        let prizes = [];
        let selectedPrize = null;

        const namesEl = document.querySelector(".names");
        const winnerEl = document.querySelector(".winner");
        const attrId = document.querySelector(".names").getAttribute('attr');
        const winnerContainer = document.querySelector(".winner");

        let winnerId = null;

        const init = () => {
            winnerEl.classList.add('hidden');
            namesEl.classList.add('hidden');
            winnerContainer.style.display = "none";

            const pearls = document.querySelector('.pearls');
            pearls.classList.remove('hidden');
            const mask = document.querySelector('.mask');
            // remove margin top
            mask.style.marginTop = 'unset';
            const imgs = mask.querySelectorAll('img');
            imgs.forEach(img => {
                img.style.width = 'auto';
            });
        }

        const onLoad = async () => {
            init();
            const initRaffle = document.querySelector('.init-raffle');
            initRaffle.classList.remove('hidden');

            const response = await fetch('/participants/view');
            const json = await response.json();
            participants = json.participants.filter(p => !p.winner);
            const prizesResponse = await fetch('/prizes/view');
            const prizesJson = await prizesResponse.json();
            prizes = prizesJson.prizes;
            buildPrizes();
        }

        const buildPrizes = () => {
            const modalBody = document.querySelector('.modal-body');
            modalBody.innerHTML = '';
            prizes.forEach(prize => {

                if (prize.left === 0) {
                    return;
                }

                const content = document.createElement('div');
                content.classList.add('content');
                content.setAttribute('attr', prize.id);
                // Add a class to indicate active state
                content.classList.add(prize.isActive && 'active');

                content.onclick = () => selectPrize(content);

                const quantity = document.createElement('div');
                quantity.classList.add('quantity');
                quantity.innerHTML = `${prize.left} / <small>${prize.quantity}</small>`;

                const prizeEl = document.createElement('div');
                prizeEl.classList.add('prize');
                const h2 = document.createElement('h2');
                h2.innerText = prize.amount;
                prizeEl.appendChild(h2);

                content.appendChild(quantity);
                content.appendChild(prizeEl);
                modalBody.appendChild(content);
            });
        };

        const openModal = () => {
            const dialog = document.querySelector('dialog');
            dialog.showModal();
        }

        const closeModal = () => {
            console.log('close')
            const dialog = document.querySelector('dialog');
            dialog.close();
        }

        const selectPrize = (element) => {
            const prizesElements = document.querySelectorAll('.content');
            prizesElements.forEach(el => {
                el.classList.remove('active');
            });
            element.classList.toggle('active');
            selectedPrize = element.getAttribute('attr');
        }

        const priceChoosed = () => {
            if (document.querySelector('.active') === null) {
                const messageEl = document.querySelector('.message-error');
                messageEl.innerText = 'Debe seleccionar al menos un premio';
                return;
            }
            const dialog = document.querySelector('dialog');
            dialog.close();

            const pearls = document.querySelector('.pearls');
            pearls.classList.add('hidden');
            const mask = document.querySelector('.mask');
            mask.style.marginTop = '72px';
            const imgs = mask.querySelectorAll('img');
            imgs.forEach(img => {
                img.style.width = '300px';
            });
            const initRaffle = document.querySelector('.init-raffle');
            initRaffle.classList.add('hidden');
            counter();
        }

        const counter = () => {
            winnerEl.classList.add('hidden');
            namesEl.classList.add('hidden');

            const counter = document.querySelector('.counter');
            counter.style.display = "flex";
            let count = 3;
            counter.innerText = count;
            const interval = setInterval(() => {
                count--;
                counter.innerText = count;
                if (count === 0) {
                    clearInterval(interval);
                    counter.style.display = "none";

                    // show raffle
                    showRaffle();
                }
            }, 1000);
        }

        function randomName() {
            const rand = Math.floor(Math.random() * participants.length);
            const name = participants[rand].name;
            namesEl.setAttribute('attr', participants[rand].id);
        
            namesEl.innerText = capitalize(name);
        }

        function showRaffle() {
            winnerEl.classList.add("hidden");
            namesEl.classList.remove("hidden");
            winnerContainer.style.display = "none";

            setDeceleratingTimeout(randomName, 10, 30);

            setTimeout(() => {
                winnerContainer.style.display = "flex";
                winnerId = namesEl.getAttribute('attr');

                const winner = participants.find(p => p.id === winnerId);
                const amount = prizes.find(p => p.id === selectedPrize).amount;

                winnerEl.querySelector(".name").innerText = capitalize(namesEl.innerText);
                winnerEl.querySelector(".department").innerText = `${winner.department} - ${winner.company}`;
                winnerEl.querySelector(".the-winner").innerText = `El ganador de ${amount} es:`;


                console.log(winnerId)

                namesEl.classList.add("hidden");
                winnerEl.classList.remove("hidden");

            }, 4000);

        }

        const setDeceleratingTimeout = (callback, factor, times) => {
            const internalCallback = ((t, counter) => {
                return () => {
                    if (--t > 0) {
                        setTimeout(internalCallback, ++counter * factor);
                        callback();
                    }
                };
            })(times, 0);

            setTimeout(internalCallback, factor);
        }

        const restartInitRaffle = async () => {
            // const winnerId = namesEl.getAttribute('attr');
            console.log(winnerId)
            await fetch(`/participants/winner/${winnerId}/${selectedPrize}`, {
                method: 'PUT'
            });
            onLoad();
        }

        const genereNewRaffle = () => {
            winnerContainer.style.display = "none";
            counter();
        }

    </script>
</body>

</html>